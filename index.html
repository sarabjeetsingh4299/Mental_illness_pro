<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Cool-Mind AI Tracker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ§ </text></svg>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #6366f1;
      --secondary: #8b5cf6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg-light: #f8fafc;
      --bg-card: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --border: #e2e8f0;
      --shadow: rgba(0, 0, 0, 0.1);
    }

    [data-theme="dark"] {
      --primary: #818cf8;
      --secondary: #a78bfa;
      --success: #34d399;
      --warning: #fbbf24;
      --danger: #f87171;
      --bg-light: #0f172a;
      --bg-card: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border: #334155;
      --shadow: rgba(0, 0, 0, 0.3);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html {
      scroll-behavior: smooth;
      -webkit-text-size-adjust: 100%;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--bg-light) 0%, #e0e7ff 100%);
      color: var(--text-primary);
      min-height: 100vh;
      transition: all 0.3s ease;
      overflow-x: hidden;
    }

    [data-theme="dark"] body {
      background: linear-gradient(135deg, var(--bg-light) 0%, #1e1b4b 100%);
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 20px;
      box-shadow: 0 20px 60px var(--shadow);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      color: var(--text-primary);
      font-size: 20px;
    }

    .modal-close {
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: var(--bg-light);
      color: var(--text-primary);
    }

    .modal-body {
      padding: 24px;
      color: var(--text-primary);
      max-height: 60vh;
      overflow-y: auto;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .modal-input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--bg-light);
      color: var(--text-primary);
      font-size: 14px;
      margin-top: 12px;
    }

    .modal-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .emergency-btn {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      border-radius: 12px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .emergency-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .emergency-btn:active {
      transform: translateY(0);
    }

    .emergency-btn i {
      font-size: 24px;
      flex-shrink: 0;
    }

    .emergency-btn div {
      text-align: left;
      flex: 1;
      min-width: 0;
    }

    .emergency-btn strong {
      display: block;
      margin-bottom: 2px;
    }

    details summary {
      list-style: none;
      transition: all 0.3s ease;
    }

    details summary::-webkit-details-marker {
      display: none;
    }

    details summary::before {
      content: 'â–¶';
      display: inline-block;
      margin-right: 8px;
      transition: transform 0.3s ease;
    }

    details[open] summary::before {
      transform: rotate(90deg);
    }

    details summary:hover {
      background: var(--border);
    }

    .app { max-width: 1400px; margin: 0 auto; padding: 20px; }

    .glass-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px var(--shadow);
      padding: 32px;
      margin-bottom: 24px;
      transition: all 0.3s ease;
    }

    [data-theme="dark"] .glass-card {
      background: rgba(30, 41, 59, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .glass-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 48px var(--shadow);
    }

    .header { display: flex; justify-content: space-between; align-items: center; }

    .logo { display: flex; align-items: center; gap: 12px; }

    .logo-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .logo-text h1 {
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
    }

    .logo-text p { font-size: 14px; color: var(--text-secondary); margin: 0; }

    .header-actions { display: flex; gap: 12px; align-items: center; }

    .btn-modern {
      padding: 10px 20px;
      border-radius: 12px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
    }

    .btn-primary-modern {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
    }

    .btn-primary-modern:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
    }

    .btn-primary-modern:active {
      transform: translateY(0);
    }

    .btn-outline-modern {
      background: transparent;
      border: 2px solid var(--border);
      color: var(--text-primary);
    }

    .btn-outline-modern:hover {
      background: var(--bg-light);
      transform: translateY(-2px);
    }

    .btn-outline-modern:active {
      transform: translateY(0);
    }

    .mood-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 12px;
    }

    .mood-btn {
      padding: 20px;
      border-radius: 16px;
      border: 2px solid var(--border);
      background: var(--bg-card);
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .mood-btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px var(--shadow);
    }

    .mood-btn.active {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
      transform: scale(1.05);
    }

    .mood-emoji { font-size: 36px; margin-bottom: 8px; }

    .slider-container { margin: 24px 0; }

    .slider-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .slider {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: var(--border);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      touch-action: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }

    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 12px var(--primary);
    }

    .slider::-webkit-slider-thumb:active {
      transform: scale(1.3);
    }

    .slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }

    .slider::-moz-range-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 12px var(--primary);
    }

    .slider::-moz-range-thumb:active {
      transform: scale(1.3);
    }

    .wellness-score {
      text-align: center;
      padding: 32px;
      border-radius: 20px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
    }

    .score-value {
      font-size: 64px;
      font-weight: 700;
      margin: 16px 0;
    }

    .ai-insights {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
      border-radius: 16px;
      padding: 24px;
      border-left: 4px solid var(--primary);
    }

    .ai-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--primary);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .chart-container { position: relative; height: 300px; margin: 24px 0; }

    .ai-chat { 
      position: fixed; 
      bottom: 24px; 
      right: 24px; 
      z-index: 1000; 
    }

    .chat-button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-button:hover { 
      transform: scale(1.1); 
    }

    .chat-window {
      position: fixed;
      bottom: 100px;
      right: 24px;
      width: 380px;
      height: 550px;
      background: var(--bg-card);
      border-radius: 20px;
      box-shadow: 0 12px 48px var(--shadow);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 1001;
    }

    .chat-window.active { 
      display: flex; 
    }

    .chat-header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 16px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.3s ease;
    }

    .chat-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .chat-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .chat-backdrop.active {
      display: block;
    }

    .chat-messages { flex: 1; overflow-y: auto; padding: 16px; }

    .chat-message {
      margin-bottom: 12px;
      padding: 12px;
      border-radius: 12px;
      max-width: 80%;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .chat-message strong {
      font-weight: 700;
      color: inherit;
    }

    .chat-message.user {
      background: var(--primary);
      color: white;
      margin-left: auto;
    }

    .chat-message.ai {
      background: var(--bg-light);
      color: var(--text-primary);
    }

    .chat-input {
      display: flex;
      padding: 16px;
      border-top: 1px solid var(--border);
    }

    .chat-input input {
      flex: 1;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-right: 8px;
      background: var(--bg-light);
      color: var(--text-primary);
      font-size: 16px;
      -webkit-appearance: none;
      appearance: none;
    }

    .chat-input input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 24px;
      margin: 24px 0;
    }

    .stat-card {
      padding: 24px;
      border-radius: 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 12px;
    }

    .fade-in { animation: fadeIn 0.5s ease; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 768px) {
      .app { padding: 12px; }
      .glass-card { padding: 20px; border-radius: 16px; }
      
      .header { 
        flex-direction: column; 
        gap: 16px; 
        text-align: center;
      }
      
      .logo { 
        flex-direction: column; 
        text-align: center; 
      }
      
      .logo-text h1 { font-size: 24px; }
      .logo-text p { font-size: 12px; }
      
      .header-actions { 
        flex-direction: row; 
        justify-content: center; 
        width: 100%;
        gap: 8px;
      }
      
      .mood-selector { 
        grid-template-columns: repeat(3, 1fr); 
        gap: 8px;
      }
      
      .mood-btn { 
        padding: 12px 8px; 
      }
      
      .mood-emoji { 
        font-size: 28px; 
        margin-bottom: 4px; 
      }
      
      .mood-btn div { 
        font-size: 12px; 
      }
      
      .wellness-score { 
        padding: 24px 16px; 
      }
      
      .score-value { 
        font-size: 48px; 
      }
      
      .grid-2 { 
        grid-template-columns: repeat(2, 1fr); 
        gap: 12px; 
      }
      
      .stat-card { 
        padding: 16px; 
      }
      
      .stat-icon { 
        width: 40px; 
        height: 40px; 
        font-size: 20px; 
      }
      
      .chart-container { 
        height: 250px; 
      }
      
      .chat-close {
        display: flex;
      }
      
      .chat-window { 
        position: fixed;
        bottom: 0;
        right: 0;
        left: 0;
        top: auto;
        width: 100%;
        height: 70vh;
        max-height: 70vh;
        border-radius: 20px 20px 0 0;
        margin: 0;
      }
      
      .chat-button {
        width: 56px;
        height: 56px;
        font-size: 22px;
      }
      
      .ai-chat {
        bottom: 20px;
        right: 20px;
      }
      
      .chat-messages {
        padding: 12px;
      }
      
      .chat-message {
        font-size: 14px;
        padding: 10px;
      }
      
      .chat-input {
        padding: 12px;
      }
      
      .chat-input input {
        font-size: 16px;
        padding: 10px;
      }
      
      .chat-header {
        padding: 14px;
        font-size: 15px;
      }
      
      .btn-modern { 
        padding: 8px 12px; 
        font-size: 14px; 
      }
      
      .slider-label { 
        font-size: 14px; 
      }
      
      .emergency-btn { 
        padding: 12px; 
        gap: 12px; 
      }
      
      .emergency-btn i { 
        font-size: 20px; 
      }
      
      .emergency-btn div strong { 
        font-size: 14px; 
      }
      
      .emergency-btn div div { 
        font-size: 11px; 
      }
      
      .modal-content { 
        width: 95%; 
        max-height: 90vh; 
      }
      
      .modal-header { 
        padding: 16px; 
      }
      
      .modal-body { 
        padding: 16px; 
      }
      
      .modal-footer { 
        padding: 12px 16px; 
        flex-wrap: wrap; 
      }
      
      .modal-footer button { 
        flex: 1; 
        min-width: 120px; 
      }
      
      details summary { 
        font-size: 14px; 
        padding: 10px; 
      }
      
      details div { 
        font-size: 13px; 
      }
      
      #noteTitle, #noteBody { 
        font-size: 14px; 
      }
      
      #contactName, #contactNumber { 
        font-size: 14px; 
      }
    }

    @media (max-width: 480px) {
      .logo-icon { 
        width: 40px; 
        height: 40px; 
        font-size: 20px; 
      }
      
      .logo-text h1 { 
        font-size: 20px; 
      }
      
      .mood-selector { 
        grid-template-columns: repeat(2, 1fr); 
      }
      
      .grid-2 { 
        grid-template-columns: 1fr; 
      }
      
      .score-value { 
        font-size: 40px; 
      }
      
      .wellness-score div { 
        font-size: 14px; 
      }
      
      .glass-card h3 { 
        font-size: 18px; 
      }
      
      .glass-card h4 { 
        font-size: 16px; 
      }
      
      .chat-window { 
        position: fixed;
        bottom: 0;
        right: 0;
        left: 0;
        top: auto;
        width: 100%;
        height: 75vh;
        max-height: 75vh;
        border-radius: 16px 16px 0 0;
      }
      
      .chat-button {
        width: 52px;
        height: 52px;
        font-size: 20px;
      }
      
      .ai-chat {
        bottom: 16px;
        right: 16px;
      }
      
      .chat-messages {
        padding: 10px;
      }
      
      .chat-message {
        font-size: 13px;
        padding: 9px;
        max-width: 85%;
      }
      
      .chat-input {
        padding: 10px;
      }
      
      .chat-input input {
        padding: 9px;
        margin-right: 6px;
      }
      
      .chat-input button {
        padding: 9px 12px;
      }
      
      .emergency-btn { 
        flex-direction: column; 
        text-align: center; 
        padding: 16px; 
      }
      
      .emergency-btn div { 
        text-align: center; 
      }
      
      .modal-footer { 
        flex-direction: column; 
      }
      
      .modal-footer button { 
        width: 100%; 
      }
      
      .btn-modern { 
        padding: 10px 14px; 
        font-size: 13px; 
      }
      
      #contactName, #contactNumber { 
        min-width: 0; 
      }
    }

    @media (max-width: 360px) {
      .app { 
        padding: 8px; 
      }
      
      .glass-card { 
        padding: 16px; 
      }
      
      .mood-selector { 
        gap: 6px; 
      }
      
      .mood-btn { 
        padding: 10px 6px; 
      }
      
      .mood-emoji { 
        font-size: 24px; 
      }
      
      .score-value { 
        font-size: 36px; 
      }
      
      .chat-button { 
        width: 48px; 
        height: 48px; 
        font-size: 18px; 
      }
      
      .ai-chat {
        bottom: 12px;
        right: 12px;
      }
      
      .chat-window {
        bottom: 0;
        right: 0;
        left: 0;
        width: 100%;
        height: 80vh;
        max-height: 80vh;
        border-radius: 12px 12px 0 0;
      }
      
      .chat-header {
        padding: 12px;
        font-size: 14px;
      }
      
      .chat-messages {
        padding: 8px;
      }
      
      .chat-message {
        font-size: 12px;
        padding: 8px;
      }
      
      .chat-input {
        padding: 8px;
      }
      
      .chat-input input {
        padding: 8px;
        font-size: 15px;
      }
    }

    /* Landscape mode for mobile */
    @media (max-height: 600px) and (orientation: landscape) {
      .chat-window {
        height: 80vh;
        max-height: none;
        bottom: 60px;
      }
      
      .chat-messages {
        flex: 1;
        overflow-y: auto;
      }
      
      .wellness-score {
        padding: 16px;
      }
      
      .score-value {
        font-size: 36px;
      }
    }
  </style>
</head>

<body>
  <!-- Modal Container -->
  <div id="modalOverlay" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Message</h3>
        <button class="modal-close" onclick="closeModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Dynamic content -->
      </div>
      <div class="modal-footer" id="modalFooter">
        <!-- Dynamic buttons -->
      </div>
    </div>
  </div>

  <div class="app">
    <div class="glass-card">
      <div class="header">
        <div class="logo">
          <div class="logo-icon">ðŸ§ </div>
          <div class="logo-text">
            <h1>Cool-Mind AI</h1>
            <p>AI-Powered Mental Wellness Tracker</p>
          </div>
        </div>
        <div class="header-actions">
          <div style="text-align: right; margin-right: 12px; color: var(--text-secondary); font-size: 14px;">
            <div id="todayLabel"></div>
            <div id="localTime"></div>
          </div>
          <button id="debugPanel" class="btn-outline-modern btn-modern" title="Debug Panel">
            <i class="bi bi-bug"></i>
          </button>
          <button id="configureAI" class="btn-outline-modern btn-modern" title="Configure Gemini AI">
            <i class="bi bi-gear"></i>
          </button>
          <button id="themeToggle" class="btn-outline-modern btn-modern">
            <i id="themeIcon" class="bi bi-moon"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="glass-card fade-in">
      <div class="wellness-score">
        <div style="font-size: 18px; opacity: 0.9;">Today's Wellness Score</div>
        <div class="score-value" id="wellnessScore">--</div>
        <div id="wellnessText" style="font-size: 16px; opacity: 0.9;">Track your mood to see your score</div>
      </div>
    </div>

    <div class="glass-card fade-in" id="aiInsightsCard" style="display: none;">
      <div class="ai-insights">
        <div class="ai-badge">
          <i class="bi bi-stars"></i> AI Insights
        </div>
        <div id="aiInsightsContent"></div>
      </div>
    </div>

    <div class="glass-card fade-in">
      <h3 style="margin-bottom: 24px;">
        <i class="bi bi-emoji-smile"></i> How are you feeling today?
      </h3>
      <div class="mood-selector" id="moodRow"></div>

      <div style="margin-top: 32px;">
        <div class="slider-container">
          <div class="slider-label">
            <span><i class="bi bi-heart-pulse"></i> Anxiety Level</span>
            <span id="anxietyVal">5</span>
          </div>
          <input type="range" class="slider" id="anxiety" min="0" max="10" value="5">
        </div>

        <div class="slider-container">
          <div class="slider-label">
            <span><i class="bi bi-activity"></i> Stress Level</span>
            <span id="stressVal">5</span>
          </div>
          <input type="range" class="slider" id="stress" min="0" max="10" value="5">
        </div>

        <div class="slider-container">
          <div class="slider-label">
            <span><i class="bi bi-bullseye"></i> Focus</span>
            <span id="focusVal">5</span>
          </div>
          <input type="range" class="slider" id="focus" min="0" max="10" value="5">
        </div>

        <div class="slider-container">
          <div class="slider-label">
            <span><i class="bi bi-graph-up"></i> Productivity</span>
            <span id="prodVal">5</span>
          </div>
          <input type="range" class="slider" id="prodRange" min="0" max="10" value="5">
        </div>

        <div class="slider-container">
          <div class="slider-label">
            <span><i class="bi bi-lightning"></i> Energy</span>
            <span id="energyVal">5</span>
          </div>
          <input type="range" class="slider" id="energy" min="0" max="10" value="5">
        </div>

        <div class="slider-container">
          <div class="slider-label">
            <span><i class="bi bi-moon-stars"></i> Sleep Hours</span>
            <span id="sleepVal">7</span>
          </div>
          <input type="range" class="slider" id="sleep" min="0" max="12" value="7">
        </div>
      </div>

      <div style="margin-top: 32px;">
        <h4 style="margin-bottom: 16px;"><i class="bi bi-journal-text"></i> Daily Journal</h4>
        <input type="text" id="noteTitle" placeholder="Title (optional)" 
               style="width: 100%; border-radius: 12px; padding: 12px; border: 1px solid var(--border); background: var(--bg-light); margin-bottom: 12px;">
        <textarea id="noteBody" rows="4" placeholder="How was your day? What's on your mind?"
                  style="width: 100%; border-radius: 12px; padding: 12px; border: 1px solid var(--border); background: var(--bg-light);"></textarea>
      </div>

      <div style="display: flex; gap: 12px; margin-top: 24px; flex-wrap: wrap;">
        <button id="saveBtn" class="btn-primary-modern btn-modern">
          <i class="bi bi-save"></i> Save Entry
        </button>
        <button id="clearBtn" class="btn-outline-modern btn-modern">
          <i class="bi bi-trash"></i> Clear
        </button>
        <button id="exportBtn" class="btn-outline-modern btn-modern">
          <i class="bi bi-download"></i> Export
        </button>
        <button id="analyzeBtn" class="btn-outline-modern btn-modern">
          <i class="bi bi-stars"></i> AI Analysis
        </button>
      </div>
    </div>

    <div class="glass-card fade-in">
      <h3 style="margin-bottom: 24px;"><i class="bi bi-graph-up-arrow"></i> Your Progress</h3>
      <div class="chart-container">
        <canvas id="trendChart"></canvas>
      </div>
    </div>

    <div class="grid-2 fade-in">
      <div class="stat-card">
        <div class="stat-icon" style="background: rgba(99, 102, 241, 0.1); color: var(--primary);">
          <i class="bi bi-calendar-check"></i>
        </div>
        <h4 id="totalEntries">0</h4>
        <p style="color: var(--text-secondary); margin: 0;">Total Entries</p>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: var(--success);">
          <i class="bi bi-trophy"></i>
        </div>
        <h4 id="avgScore">--</h4>
        <p style="color: var(--text-secondary); margin: 0;">Average Score</p>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: var(--warning);">
          <i class="bi bi-fire"></i>
        </div>
        <h4 id="streak">0</h4>
        <p style="color: var(--text-secondary); margin: 0;">Day Streak</p>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background: rgba(139, 92, 246, 0.1); color: var(--secondary);">
          <i class="bi bi-emoji-smile"></i>
        </div>
        <h4 id="bestMood">--</h4>
        <p style="color: var(--text-secondary); margin: 0;">Most Common Mood</p>
      </div>
    </div>

    <div class="glass-card fade-in">
      <h3 style="margin-bottom: 24px;"><i class="bi bi-clock-history"></i> Recent Entries</h3>
      <div id="entriesList"></div>
    </div>

    <div class="glass-card fade-in">
      <h3 style="margin-bottom: 24px;"><i class="bi bi-telephone"></i> Emergency Contacts</h3>
      
      <!-- Crisis Hotlines -->
      <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(245, 158, 11, 0.1)); border-radius: 16px; padding: 20px; margin-bottom: 20px; border-left: 4px solid var(--danger);">
        <h4 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
          <i class="bi bi-exclamation-triangle-fill" style="color: var(--danger);"></i>
          Crisis Support - Available 24/7
        </h4>
        <div style="display: grid; gap: 12px;">
          <a href="tel:988" class="emergency-btn" style="background: var(--danger); color: white;">
            <i class="bi bi-telephone-fill"></i>
            <div>
              <strong>988 - Suicide & Crisis Lifeline</strong>
              <div style="font-size: 12px; opacity: 0.9;">24/7 Free & Confidential Support</div>
            </div>
          </a>
          <a href="sms:741741&body=HOME" class="emergency-btn" style="background: var(--warning); color: white;">
            <i class="bi bi-chat-dots-fill"></i>
            <div>
              <strong>Text HOME to 741741</strong>
              <div style="font-size: 12px; opacity: 0.9;">Crisis Text Line</div>
            </div>
          </a>
          <a href="tel:911" class="emergency-btn" style="background: var(--danger); color: white;">
            <i class="bi bi-shield-fill-exclamation"></i>
            <div>
              <strong>911 - Emergency Services</strong>
              <div style="font-size: 12px; opacity: 0.9;">Police, Fire, Medical Emergency</div>
            </div>
          </a>
        </div>
      </div>

      <!-- International Crisis Lines -->
      <details style="margin-bottom: 20px; cursor: pointer;">
        <summary style="padding: 12px; background: var(--bg-light); border-radius: 12px; font-weight: 600; cursor: pointer;">
          <i class="bi bi-globe"></i> International Crisis Helplines
        </summary>
        <div style="padding: 16px; background: var(--bg-light); border-radius: 12px; margin-top: 8px;">
          <div style="display: grid; gap: 12px; font-size: 14px;">
            <div><strong>ðŸ‡¨ðŸ‡¦ Canada:</strong> 1-833-456-4566</div>
            <div><strong>ðŸ‡¬ðŸ‡§ UK:</strong> 116 123 (Samaritans)</div>
            <div><strong>ðŸ‡¦ðŸ‡º Australia:</strong> 13 11 14 (Lifeline)</div>
            <div><strong>ðŸ‡®ðŸ‡³ India:</strong> 9152987821 (AASRA)</div>
            <div><strong>ðŸ‡©ðŸ‡ª Germany:</strong> 0800 111 0 111</div>
            <div><strong>ðŸ‡«ðŸ‡· France:</strong> 01 45 39 40 00</div>
            <div><strong>ðŸ‡¯ðŸ‡µ Japan:</strong> 03-5774-0992</div>
            <div><strong>ðŸ‡§ðŸ‡· Brazil:</strong> 188 (CVV)</div>
            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);">
              <a href="https://findahelpline.com" target="_blank" style="color: var(--primary); text-decoration: none;">
                <i class="bi bi-search"></i> Find more helplines worldwide â†’
              </a>
            </div>
          </div>
        </div>
      </details>

      <!-- Personal Emergency Contacts -->
      <h4 style="margin-bottom: 12px;"><i class="bi bi-person-hearts"></i> Personal Emergency Contacts</h4>
      <div style="display: flex; gap: 12px; margin-bottom: 16px;">
        <input type="text" id="contactName" placeholder="Name"
               style="flex: 1; border-radius: 12px; padding: 12px; border: 1px solid var(--border); background: var(--bg-light);">
        <input type="tel" id="contactNumber" placeholder="Phone"
               style="flex: 1; border-radius: 12px; padding: 12px; border: 1px solid var(--border); background: var(--bg-light);">
        <button id="addContactBtn" class="btn-primary-modern btn-modern">
          <i class="bi bi-plus"></i>
        </button>
      </div>
      <div id="contactsWrap" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
      
      <button id="openMapsBtn" class="btn-outline-modern btn-modern" style="margin-top: 16px; width: 100%;">
        <i class="bi bi-geo-alt"></i> Find Nearby Mental Health Clinics
      </button>
    </div>

    <div style="text-align: center; padding: 24px; color: var(--text-secondary);">
      Developed by <strong>Sarabjeet Singh</strong>
    </div>
  </div>

  <div class="ai-chat">
    <button class="chat-button" id="chatToggle">
      <i class="bi bi-chat-dots"></i>
    </button>
    <div class="chat-backdrop" id="chatBackdrop"></div>
    <div class="chat-window" id="chatWindow">
      <div class="chat-header">
        <div>
          <i class="bi bi-robot"></i> AI Mental Health Assistant
          <div style="font-size: 11px; opacity: 0.8; margin-top: 2px;" id="aiStatus">
            Fallback Mode
          </div>
        </div>
        <button class="chat-close" id="chatClose">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="chat-message ai">
          Hi! I'm your AI mental health assistant. How can I support you today?
          <div style="font-size: 11px; opacity: 0.7; margin-top: 4px;">
            Status: <span id="chatStatus">Loading...</span>
          </div>
        </div>
      </div>
      <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Type your message...">
        <button class="btn-primary-modern btn-modern" id="chatSend">
          <i class="bi bi-send"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
// Modal Functions
function showModal(title, body, buttons = []) {
  const overlay = document.getElementById("modalOverlay");
  const modalTitle = document.getElementById("modalTitle");
  const modalBody = document.getElementById("modalBody");
  const modalFooter = document.getElementById("modalFooter");

  modalTitle.textContent = title;
  modalBody.innerHTML = body;
  
  modalFooter.innerHTML = "";
  buttons.forEach(btn => {
    const button = document.createElement("button");
    button.className = btn.primary ? "btn-primary-modern btn-modern" : "btn-outline-modern btn-modern";
    button.innerHTML = btn.text;
    button.onclick = () => {
      if (btn.onClick) btn.onClick();
      if (btn.closeOnClick !== false) closeModal();
    };
    modalFooter.appendChild(button);
  });

  overlay.style.display = "flex";
}

function closeModal() {
  document.getElementById("modalOverlay").style.display = "none";
}

function showAlert(message, title = "Message") {
  showModal(title, `<p>${message}</p>`, [
    { text: '<i class="bi bi-check"></i> OK', primary: true }
  ]);
}

function showConfirm(message, onConfirm, title = "Confirm") {
  showModal(title, `<p>${message}</p>`, [
    { text: '<i class="bi bi-x"></i> Cancel', primary: false },
    { text: '<i class="bi bi-check"></i> Confirm', primary: true, onClick: onConfirm }
  ]);
}

function showPrompt(message, onSubmit, title = "Input", placeholder = "") {
  const inputId = "modalPromptInput";
  showModal(
    title,
    `<p>${message}</p><input type="text" id="${inputId}" class="modal-input" placeholder="${placeholder}" />`,
    [
      { text: '<i class="bi bi-x"></i> Cancel', primary: false },
      { 
        text: '<i class="bi bi-check"></i> Submit', 
        primary: true, 
        onClick: () => {
          const value = document.getElementById(inputId).value.trim();
          if (value) onSubmit(value);
        }
      }
    ]
  );
  setTimeout(() => document.getElementById(inputId).focus(), 100);
}

// Close modal on overlay click
document.addEventListener("click", (e) => {
  if (e.target.id === "modalOverlay") closeModal();
});

// Close modal on Escape key
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeModal();
});

class AIAssistant {
  constructor() {
    this.apiKey = null; // Will be set by user
    this.baseURL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent';
    this.isGeminiEnabled = false;
    
    // Fallback responses for when Gemini is not available
    this.fallbackResponses = {
      greeting: [
        "Hello! I'm here to support your mental wellness journey. How are you feeling today?",
        "Hi there! I'm your AI mental health companion. What's on your mind?",
        "Welcome! I'm here to listen and help. How can I support you today?"
      ],
      anxiety: [
        "I understand anxiety can be overwhelming. Try the **4-7-8 breathing technique**: breathe in for 4 seconds, hold for 7, exhale for 8.",
        "Anxiety is tough, but you're not alone. Try the **5-4-3-2-1 grounding technique**: Name 5 things you see, 4 you can touch, 3 you hear, 2 you smell, and 1 you taste.",
        "When anxiety strikes, remember: **this feeling is temporary**. Try progressive muscle relaxation or a short walk."
      ],
      stress: [
        "Stress management is key. Try the **Pomodoro Technique**: Work for 25 minutes, then take a 5-minute break.",
        "When overwhelmed, **break tasks into tiny steps**. Instead of 'finish project', try 'write first paragraph'.",
        "Remember to be kind to yourself. **You're doing your best**, and that's enough."
      ],
      support: [
        "Remember, seeking help is a sign of strength, not weakness.",
        "You're taking important steps by tracking your mental health. That's commendable!",
        "Every day is a new opportunity. Be patient and kind with yourself."
      ]
    };
  }

  // Set Gemini API key
  setApiKey(apiKey) {
    console.log('ðŸ”§ Setting API key:', apiKey ? `${apiKey.length} characters` : 'null/empty');
    this.apiKey = apiKey;
    this.isGeminiEnabled = !!apiKey;
    if (apiKey) {
      localStorage.setItem('gemini_api_key', apiKey);
    } else {
      localStorage.removeItem('gemini_api_key');
    }
    console.log('âœ… API Key set. isGeminiEnabled:', this.isGeminiEnabled);
  }

  // Load API key from storage
  loadApiKey() {
    const savedKey = localStorage.getItem('gemini_api_key');
    console.log('ðŸ”„ Loading API key from localStorage...');
    console.log('ðŸ”‘ Found saved key:', savedKey ? `Yes (${savedKey.length} chars)` : 'No');
    if (savedKey) {
      this.setApiKey(savedKey);
      console.log('âœ… API key loaded and set');
    } else {
      console.log('âš ï¸ No API key found in localStorage');
    }
  }

  // Generate system prompt for mental health context
  generateSystemPrompt(userHistory = []) {
    const recentEntry = userHistory.length > 0 ? userHistory[userHistory.length - 1] : null;
    
    let prompt = `You are a compassionate AI mental health assistant. Provide supportive, empathetic responses about mental health in 2-3 sentences. Offer evidence-based coping strategies. Encourage professional help when appropriate. NEVER provide medical diagnoses. Be encouraging and non-judgmental.

SAFETY: If someone mentions self-harm or suicide, provide crisis resources immediately.

User context:`;

    if (recentEntry) {
      prompt += ` Recent mood: ${this.getMoodLabel(recentEntry.mood)}, Anxiety: ${recentEntry.anxiety}/10, Stress: ${recentEntry.stress}/10`;
    } else {
      prompt += ` New user starting mental wellness tracking`;
    }

    return prompt;
  }

  getMoodLabel(moodId) {
    const moods = ['Very low', 'Low', 'Okay', 'Good', 'Great'];
    return moods[moodId] || 'Unknown';
  }

  // Call Gemini API with simplified request
  async callGeminiAPI(message, userHistory = []) {
    if (!this.isGeminiEnabled) {
      throw new Error('Gemini API not configured');
    }

    // Simple, direct prompt for mental health support
    const prompt = `You are a supportive mental health assistant. Respond to this message with empathy and helpful advice in 1-2 sentences: "${message}"`;

    try {
      console.log('ðŸ¤– Calling Gemini API...');
      console.log('ï¿½ API Ktey exists:', !!this.apiKey);
      console.log('ðŸŒ URL:', this.baseURL);
      
      const requestBody = {
        contents: [{
          parts: [{
            text: prompt
          }]
        }],
        generationConfig: {
          temperature: 0.7,
          maxOutputTokens: 1000
        }
      };

      console.log('ðŸ“¤ Making request...');
      
      const response = await fetch(this.baseURL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-goog-api-key': this.apiKey
        },
        body: JSON.stringify(requestBody)
      });

      console.log('ðŸ“¥ Response received:', response.status, response.statusText);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('âŒ API Error:', errorText);
        throw new Error(`API Error ${response.status}: ${errorText}`);
      }

      const data = await response.json();
      console.log('ðŸ“Š Full API Response:', data);
      
      if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
        const responseText = data.candidates[0].content.parts[0].text.trim();
        console.log('âœ… Gemini Response:', responseText);
        return responseText;
      } else {
        console.error('âŒ Unexpected response structure:', data);
        throw new Error('Invalid response from Gemini API');
      }
      
    } catch (error) {
      console.error('ðŸ’¥ Gemini API Error:', error);
      throw error;
    }
  }

  // Main chat response method
  async chatResponse(message, userHistory = []) {
    console.log('ðŸŽ¯ Chat request:', message);
    console.log('ðŸ”§ Gemini enabled:', this.isGeminiEnabled);
    console.log('ðŸ”‘ API key exists:', !!this.apiKey);
    console.log('ðŸ”‘ API key length:', this.apiKey ? this.apiKey.length : 0);
    console.log('ðŸŒ Base URL:', this.baseURL);
    
    // Try Gemini first if available
    if (this.isGeminiEnabled && this.apiKey) {
      try {
        console.log('ðŸš€ Attempting Gemini API call...');
        const response = await this.callGeminiAPI(message, userHistory);
        console.log('âœ… Using Gemini response:', response);
        
        // Clean up markdown formatting
        const cleanResponse = response.replace(/\*\*(.*?)\*\*/g, '$1').replace(/\*(.*?)\*/g, '$1');
        return cleanResponse;
      } catch (error) {
        console.error('âŒ Gemini failed, using fallback:', error.message);
        console.error('âŒ Full error:', error);
        // Fall through to local responses
      }
    } else {
      console.log('âš ï¸ Gemini not enabled or no API key, using fallback');
      console.log('âš ï¸ isGeminiEnabled:', this.isGeminiEnabled);
      console.log('âš ï¸ apiKey exists:', !!this.apiKey);
    }

    // Fallback to local pattern-based responses
    console.log('ðŸ”„ Using fallback responses');
    const fallbackResponse = this.getLocalResponse(message, userHistory);
    return fallbackResponse;
  }

  // Local pattern-based responses (fallback)
  getLocalResponse(message, userHistory = []) {
    const lowerMsg = message.toLowerCase();
    const recentEntry = userHistory.length > 0 ? userHistory[userHistory.length - 1] : null;
    
    // Crisis detection
    if (lowerMsg.match(/\b(suicide|kill myself|end it all|want to die|hurt myself|self harm)\b/)) {
      return "ðŸš¨ **I'm very concerned about you.** Please reach out for immediate help:\n\n**988** - Suicide & Crisis Lifeline (US)\n**Crisis Text Line**: Text HOME to 741741\n**International**: findahelpline.com\n\nYou matter, and there are people who want to help. Please don't face this alone.";
    }

    // Greetings with personalization
    if (lowerMsg.match(/\b(hello|hi|hey|good morning|good evening|greetings)\b/)) {
      const greetings = [
        "Hello! I'm here to support your mental wellness journey. How are you feeling today?",
        "Hi there! I'm your AI mental health companion. What's on your mind?",
        "Welcome back! I'm here to listen and help. How can I support you today?",
        recentEntry ? `Hi! I see you've been tracking for ${userHistory.length} days. How are things going?` : "Hello! Ready to talk about how you're feeling?",
      ];
      return greetings[Math.floor(Math.random() * greetings.length)];
    }
    
    // Anxiety-related responses
    if (lowerMsg.match(/\b(anxious|anxiety|panic|worried|nervous|fear|scared)\b/)) {
      const responses = this.fallbackResponses.anxiety;
      let response = responses[Math.floor(Math.random() * responses.length)];
      
      if (recentEntry && recentEntry.anxiety > 7) {
        response += "\n\nI noticed your anxiety has been high lately. Consider talking to a mental health professional for additional support.";
      }
      
      return response;
    }
    
    // Stress management
    if (lowerMsg.match(/\b(stress|stressed|overwhelm|overwhelmed|pressure|burnout)\b/)) {
      const responses = this.fallbackResponses.stress;
      let response = responses[Math.floor(Math.random() * responses.length)];
      
      if (recentEntry && recentEntry.stress > 7) {
        response += "\n\nYour stress levels have been consistently high. This might be a good time to evaluate what you can delegate or say no to.";
      }
      
      return response;
    }
    
    // Default supportive response
    const supportResponses = this.fallbackResponses.support;
    return supportResponses[Math.floor(Math.random() * supportResponses.length)];
  }

  analyzeEntry(entry) {
    const insights = [];
    const score = this.computeScore(entry);

    if (entry.mood <= 1) {
      insights.push("ðŸ”µ Your mood seems low today. Consider reaching out to someone you trust or engaging in an activity you enjoy.");
    } else if (entry.mood >= 3) {
      insights.push("ðŸŸ¢ Great mood today! Keep doing what you're doing.");
    }

    if (entry.anxiety >= 7 || entry.stress >= 7) {
      insights.push("ðŸŸ¡ High anxiety/stress detected. Try deep breathing exercises or a short meditation session.");
    }

    if (entry.sleep < 6) {
      insights.push("ðŸŸ  You're not getting enough sleep. Aim for 7-9 hours for optimal mental health.");
    } else if (entry.sleep > 9) {
      insights.push("ðŸŸ  You might be oversleeping. This can sometimes indicate depression or other issues.");
    }

    if (entry.focus < 4 && entry.prod < 4) {
      insights.push("ðŸ”´ Low focus and productivity. Take breaks, stay hydrated, and consider the Pomodoro technique.");
    }

    if (entry.energy < 4) {
      insights.push("âš¡ Low energy levels. Make sure you're eating well, staying hydrated, and getting some physical activity.");
    }

    if (score >= 80) {
      insights.push("âœ¨ Excellent wellness score! You're in a great place mentally.");
    } else if (score < 50) {
      insights.push("â¤ï¸ Your wellness score suggests you might need extra support. Consider talking to a mental health professional.");
    }

    return insights;
  }

  generateRecommendations(history) {
    const recommendations = [];
    
    if (history.length < 3) {
      return ["ðŸ“Š Keep tracking daily to unlock personalized AI insights and patterns!"];
    }

    const avgAnxiety = history.reduce((sum, e) => sum + e.anxiety, 0) / history.length;
    const avgStress = history.reduce((sum, e) => sum + e.stress, 0) / history.length;
    const avgSleep = history.reduce((sum, e) => sum + e.sleep, 0) / history.length;

    if (avgAnxiety > 6) {
      recommendations.push("ðŸ§˜ Your anxiety levels have been consistently high. Consider mindfulness meditation or yoga.");
    }

    if (avgStress > 6) {
      recommendations.push("ðŸ’† Chronic stress detected. Try stress-management techniques like journaling or talking to a therapist.");
    }

    if (avgSleep < 6.5) {
      recommendations.push("ðŸ˜´ You're averaging less sleep than recommended. Prioritize sleep hygiene for better mental health.");
    }

    const recentMoods = history.slice(-7).map(e => e.mood);
    const moodTrend = recentMoods[recentMoods.length - 1] - recentMoods[0];
    
    if (moodTrend > 1) {
      recommendations.push("ðŸ“ˆ Your mood has been improving! Keep up whatever you're doing.");
    } else if (moodTrend < -1) {
      recommendations.push("ðŸ“‰ Your mood has been declining. This might be a good time to reach out for support.");
    }

    return recommendations.length > 0 ? recommendations : ["âœ… You're doing well! Keep tracking to maintain your mental wellness."];
  }

  computeScore(entry) {
    // Ensure all required properties exist and are numbers
    const mood = Number(entry.mood) || 0;
    const prod = Number(entry.prod) || 0;
    const focus = Number(entry.focus) || 0;
    const energy = Number(entry.energy) || 0;
    const sleep = Number(entry.sleep) || 7;
    const stress = Number(entry.stress) || 0;
    const anxiety = Number(entry.anxiety) || 0;

    const moodS = mood / 4;
    const prodS = prod / 10;
    const focusS = focus / 10;
    const energyS = energy / 10;
    const sleepS = Math.max(0, 1 - Math.abs(7 - sleep) / 7);
    const negative = (stress + anxiety) / 20;

    const weighted =
      moodS * 0.22 +
      prodS * 0.22 +
      focusS * 0.18 +
      energyS * 0.18 +
      sleepS * 0.20;

    const score = Math.max(0, Math.round(weighted * (1 - negative) * 100));
    
    // Ensure we never return NaN
    return isNaN(score) ? 0 : score;
  }

  analyzeSentiment(text) {
    if (!text) return "neutral";
    
    const positiveWords = ["happy", "great", "good", "excellent", "wonderful", "amazing", "better", "improved", "joy", "love"];
    const negativeWords = ["sad", "bad", "terrible", "awful", "worse", "depressed", "anxious", "worried", "scared", "hate"];
    
    const lowerText = text.toLowerCase();
    const positiveCount = positiveWords.filter(word => lowerText.includes(word)).length;
    const negativeCount = negativeWords.filter(word => lowerText.includes(word)).length;
    
    if (positiveCount > negativeCount) return "positive";
    if (negativeCount > positiveCount) return "negative";
    return "neutral";
  }

  chatResponse(message, userHistory = []) {
    const lowerMsg = message.toLowerCase();
    const words = lowerMsg.split(/\s+/);
    
    // Context-aware responses based on user history
    const hasHistory = userHistory.length > 0;
    const recentEntry = hasHistory ? userHistory[userHistory.length - 1] : null;
    
    // Greetings with personalization
    if (lowerMsg.match(/\b(hello|hi|hey|good morning|good evening|greetings)\b/)) {
      const greetings = [
        "Hello! I'm here to support your mental wellness journey. How are you feeling today?",
        "Hi there! I'm your AI mental health companion. What's on your mind?",
        "Welcome back! I'm here to listen and help. How can I support you today?",
        hasHistory ? `Hi! I see you've been tracking for ${userHistory.length} days. How are things going?` : "Hello! Ready to talk about how you're feeling?",
        "Hey! I'm all ears. What would you like to discuss today?"
      ];
      return greetings[Math.floor(Math.random() * greetings.length)];
    }
    
    // Anxiety-related with techniques
    if (lowerMsg.match(/\b(anxious|anxiety|panic|worried|nervous|fear|scared)\b/)) {
      const anxietyResponses = [
        "I understand anxiety can be overwhelming. Try the **4-7-8 breathing technique**: breathe in for 4 seconds, hold for 7, exhale for 8. This activates your parasympathetic nervous system.",
        "Anxiety is tough, but you're not alone. Try the **5-4-3-2-1 grounding technique**: Name 5 things you see, 4 you can touch, 3 you hear, 2 you smell, and 1 you taste.",
        "When anxiety strikes, remember: **this feeling is temporary**. Your body is trying to protect you, but there's no real danger right now. Try progressive muscle relaxation.",
        "Anxiety often comes from worrying about the future. Try bringing yourself to the **present moment** - focus on your breath, notice your surroundings, feel your feet on the ground.",
        "Have you tried the **STOP technique**? Stop what you're doing, Take a breath, Observe your thoughts and feelings, Proceed with something that will support you.",
        recentEntry && recentEntry.anxiety > 7 ? "I noticed your anxiety has been high lately. Consider journaling about what triggers it, or talking to a mental health professional." : "Physical exercise can really help with anxiety. Even a 10-minute walk can make a difference."
      ];
      return anxietyResponses[Math.floor(Math.random() * anxietyResponses.length)];
    }
    
    // Stress management
    if (lowerMsg.match(/\b(stress|stressed|overwhelm|overwhelmed|pressure|burnout|exhausted)\b/)) {
      const stressResponses = [
        "Stress management is key. Try the **Pomodoro Technique**: Work for 25 minutes, then take a 5-minute break. This prevents burnout.",
        "When overwhelmed, **break tasks into tiny steps**. Instead of 'finish project', try 'write first paragraph' or 'make outline'.",
        "Remember to be kind to yourself. Stress is your body's response to demands. **You're doing your best**, and that's enough.",
        "High stress? Try this: **Write down everything** on your mind, then prioritize just 3 things for today. The rest can wait.",
        "Physical signs of stress? Try **progressive muscle relaxation**: Tense each muscle group for 5 seconds, then release. Start with your toes and work up.",
        recentEntry && recentEntry.stress > 7 ? "Your stress levels have been consistently high. This might be a good time to evaluate what you can delegate or say no to." : "Don't forget: **taking breaks is productive**. Your brain needs rest to function well.",
        "Chronic stress affects your health. Consider talking to a therapist about **stress management strategies** tailored to you."
      ];
      return stressResponses[Math.floor(Math.random() * stressResponses.length)];
    }
    
    // Sleep issues
    if (lowerMsg.match(/\b(sleep|insomnia|tired|fatigue|exhausted|can't sleep|sleepy|rest)\b/)) {
      const sleepResponses = [
        "Good sleep is crucial for mental health. Try the **10-3-2-1-0 rule**: No caffeine 10hrs before bed, no food/alcohol 3hrs before, no work 2hrs before, no screens 1hr before, 0 times hitting snooze.",
        "Sleep issues can affect mood significantly. Create a **relaxing bedtime routine**: dim lights, cool room (65-68Â°F), same bedtime each night.",
        "Can't fall asleep? Try the **4-7-8 breathing** or **body scan meditation**. Don't force it - if you're awake after 20 minutes, get up and do something calming.",
        "Aim for **7-9 hours** of sleep. Your brain consolidates memories and processes emotions during sleep - it's not optional!",
        recentEntry && recentEntry.sleep < 6 ? "I see you've been getting less than 6 hours of sleep. This can seriously impact your mood and cognitive function. Prioritize sleep this week." : "Quality matters too! Avoid screens before bed - the blue light disrupts melatonin production.",
        "Struggling with racing thoughts at night? Keep a **worry journal** by your bed. Write down concerns and tell yourself you'll deal with them tomorrow.",
        "Consider your **sleep environment**: Is it dark enough? Quiet? Cool? Small changes can make a big difference."
      ];
      return sleepResponses[Math.floor(Math.random() * sleepResponses.length)];
    }
    
    // Depression symptoms
    if (lowerMsg.match(/\b(depressed|depression|sad|hopeless|empty|numb|worthless|suicidal)\b/)) {
      const depressionResponses = [
        "I hear you, and I'm concerned. If you're having thoughts of self-harm, please reach out to a crisis helpline immediately: **988 (US)** or your local emergency services.",
        "Depression is a real illness, not a weakness. **You deserve support**. Please consider talking to a mental health professional - they can really help.",
        "When you're feeling low, even small things feel impossible. That's the depression talking, not reality. **Be gentle with yourself**.",
        "Try the **behavioral activation** approach: Do one small thing you used to enjoy, even if you don't feel like it. Sometimes action comes before motivation.",
        "Depression often involves negative thought patterns. When you think 'I'm worthless', ask: **Would I say this to a friend?** Probably not. You deserve the same compassion.",
        "Reach out to someone you trust. **Connection is powerful medicine** for depression, even when you feel like isolating.",
        "If you're struggling, please don't wait. Mental health professionals have tools and strategies that can help. **You don't have to feel this way forever**."
      ];
      return depressionResponses[Math.floor(Math.random() * depressionResponses.length)];
    }
    
    // Positive emotions
    if (lowerMsg.match(/\b(happy|great|good|wonderful|amazing|excellent|fantastic|better|improved|joy|grateful)\b/)) {
      const positiveResponses = [
        "That's wonderful! ðŸŽ‰ **Savor this feeling**. What specifically is contributing to your positive mood?",
        "I'm so glad you're feeling good! This is a great time to **reflect on what's working well** so you can replicate it.",
        "Excellent! **Write down what led to this feeling** - these insights are valuable for tough days ahead.",
        "Love to hear it! ðŸ˜Š Positive emotions are worth celebrating. What's the best part of your day so far?",
        hasHistory ? `Your mood has been improving! Keep up whatever you're doing - it's working! ðŸ“ˆ` : "That's great! Keep tracking these positive moments.",
        "Wonderful! Remember: **you created this positive experience**. Give yourself credit for the choices that led here.",
        "Fantastic! On good days, it's helpful to **build your resilience reserves** - connect with others, practice gratitude, or try something new."
      ];
      return positiveResponses[Math.floor(Math.random() * positiveResponses.length)];
    }
    
    // Motivation and productivity
    if (lowerMsg.match(/\b(motivation|motivated|productive|productivity|focus|concentrate|procrastination|lazy)\b/)) {
      const motivationResponses = [
        "Motivation often comes **after** starting, not before. Try the **2-minute rule**: commit to just 2 minutes. Usually, you'll keep going.",
        "Struggling to focus? Try **time-blocking**: Dedicate specific time slots to specific tasks. Treat them like appointments.",
        "Procrastination is often about **fear or perfectionism**, not laziness. What are you really avoiding? Break it down into smaller, less scary steps.",
        "Your brain needs **variety and breaks**. Try the Pomodoro Technique: 25 minutes focused work, 5-minute break. Repeat.",
        "Low productivity might mean you need **rest, not more pressure**. Are you getting enough sleep? Taking breaks? Eating well?",
        "**Environment matters**: Clear your workspace, put phone away, use website blockers if needed. Make focus the path of least resistance.",
        recentEntry && recentEntry.focus < 4 ? "I noticed your focus has been low. Check your basics: sleep, hydration, nutrition, and stress levels." : "Set **one priority** for today. Just one. Accomplish that, and the day is a success."
      ];
      return motivationResponses[Math.floor(Math.random() * motivationResponses.length)];
    }
    
    // Relationships and social
    if (lowerMsg.match(/\b(lonely|alone|isolated|friends|relationship|social|connection|talk to someone)\b/)) {
      const socialResponses = [
        "Feeling lonely is tough. **Connection is a basic human need**. Even small interactions count - chat with a cashier, call a friend, join an online community.",
        "Quality over quantity in relationships. **One genuine connection** is worth more than dozens of superficial ones.",
        "Reaching out when you feel isolated is hard, but it's exactly what helps. **Send that text**. Most people are happy to hear from you.",
        "Social anxiety making it hard? Start small: **online communities, support groups, or activities** where the focus isn't on socializing (like classes or volunteering).",
        "Remember: **everyone feels lonely sometimes**. It doesn't mean something is wrong with you. It means you're human and need connection.",
        "If you're feeling isolated, consider **volunteering or joining a group** around your interests. Shared activities make connection easier.",
        "Don't underestimate **weak ties**: casual acquaintances and brief interactions contribute to wellbeing too."
      ];
      return socialResponses[Math.floor(Math.random() * socialResponses.length)];
    }
    
    // Self-care and wellness
    if (lowerMsg.match(/\b(self care|self-care|wellness|health|exercise|meditation|mindfulness|yoga)\b/)) {
      const selfCareResponses = [
        "Self-care isn't selfish - it's **essential maintenance**. You can't pour from an empty cup.",
        "Physical and mental health are connected. **Regular exercise** (even just walking) is as effective as medication for mild-moderate depression.",
        "Mindfulness doesn't require hours of meditation. Try **micro-moments**: One mindful breath, noticing one sensation, one moment of gratitude.",
        "Self-care basics: **Sleep, nutrition, movement, connection, and purpose**. When you're struggling, check these first.",
        "**Meditation tip**: You don't need to 'clear your mind'. Just notice thoughts without judgment, like watching clouds pass. That's the practice.",
        "Yoga combines movement, breath, and mindfulness - a **triple threat for mental health**. Even 10 minutes helps.",
        "Self-care isn't just bubble baths. Sometimes it's **setting boundaries, saying no, or having difficult conversations**. Do what truly serves you."
      ];
      return selfCareResponses[Math.floor(Math.random() * selfCareResponses.length)];
    }
    
    // Questions about the app or tracking
    if (lowerMsg.match(/\b(how|what|why|when|track|app|score|wellness|help|use)\b/) && lowerMsg.includes("?")) {
      const helpResponses = [
        "I can help you understand your **mental wellness patterns**. Track your mood daily, and I'll provide insights based on your data.",
        "Your **wellness score** is calculated from mood, stress, anxiety, focus, productivity, energy, and sleep. It gives you a quick snapshot of your overall wellbeing.",
        "**Daily tracking** helps you spot patterns - like how sleep affects mood, or what triggers stress. Knowledge is power!",
        "Use the **journal feature** to capture thoughts and feelings. Writing is therapeutic, and I can analyze sentiment to provide insights.",
        "The **AI Analysis button** gives you personalized recommendations based on your recent entries. Try it after saving a few days!",
        "I'm here to **listen, provide coping strategies, and help you understand your mental health**. I'm not a replacement for professional help, but I'm a good starting point.",
        "Track consistently for best results. Even **30 seconds a day** can reveal valuable patterns about your mental health over time."
      ];
      return helpResponses[Math.floor(Math.random() * helpResponses.length)];
    }
    
    // Thank you
    if (lowerMsg.match(/\b(thank|thanks|appreciate|grateful)\b/)) {
      const thanksResponses = [
        "You're welcome! I'm here whenever you need support. ðŸ’™",
        "Happy to help! Remember, **taking care of your mental health is important work**.",
        "Anytime! You're doing great by prioritizing your wellbeing. ðŸŒŸ",
        "My pleasure! Keep up the great work on your mental wellness journey.",
        "You're very welcome! Don't hesitate to reach out anytime you need to talk."
      ];
      return thanksResponses[Math.floor(Math.random() * thanksResponses.length)];
    }
    
    // Crisis keywords - immediate response
    if (lowerMsg.match(/\b(suicide|kill myself|end it all|want to die|hurt myself|self harm)\b/)) {
      return "ðŸš¨ **I'm very concerned about you.** Please reach out for immediate help:\n\n**988** - Suicide & Crisis Lifeline (US)\n**Crisis Text Line**: Text HOME to 741741\n**International**: findahelpline.com\n\nYou matter, and there are people who want to help. Please don't face this alone.";
    }
    
    // Default intelligent responses based on context
    const contextualDefaults = [
      "I'm here to listen. Can you tell me more about what you're experiencing?",
      "That sounds challenging. **How are you coping** with this?",
      "Thank you for sharing that with me. What would be most helpful for you right now?",
      "I hear you. **Your feelings are valid**. What do you think might help in this moment?",
      hasHistory ? `Based on your tracking, I've noticed some patterns. Would you like me to share insights about your ${userHistory.length} days of data?` : "I'm here to support you. How are you feeling today?",
      "Sometimes it helps to **break things down**. What's the most pressing thing on your mind right now?",
      "Remember: **You're not alone** in this. Many people experience similar challenges. What kind of support would help you most?",
      "That's a lot to carry. Have you been able to **talk to anyone** about this?",
      "I appreciate you opening up. **Self-awareness is the first step** to positive change. What's one small thing that might help today?"
    ];
    
    return contextualDefaults[Math.floor(Math.random() * contextualDefaults.length)];
  }

  getRandomResponse(category) {
    const responses = this.responses[category];
    return responses[Math.floor(Math.random() * responses.length)];
  }
}

const ai = new AIAssistant();

document.addEventListener("DOMContentLoaded", () => {
  const $ = id => document.getElementById(id);

  // Initialize AI
  ai.loadApiKey();
  updateAIStatus();
  
  // Show current status
  setTimeout(() => {
    console.log('ðŸš€ Cool-Mind Tracker Loaded');
    console.log('ðŸ¤– AI Status:', ai.isGeminiEnabled ? 'Gemini Enabled' : 'Fallback Mode');
    console.log('ðŸ”‘ API Key:', ai.apiKey ? 'Set (' + ai.apiKey.length + ' chars)' : 'Not Set');
    
    // Show status in chat
    updateAIStatus();
  }, 1000);

  function updateAIStatus() {
    const statusElement = $("aiStatus");
    const chatStatusElement = $("chatStatus");
    
    if (statusElement) {
      statusElement.textContent = ai.isGeminiEnabled ? 'Powered by Gemini AI' : 'Fallback Mode';
      statusElement.style.color = ai.isGeminiEnabled ? '#4ade80' : '#fbbf24';
    }
    
    if (chatStatusElement) {
      chatStatusElement.textContent = ai.isGeminiEnabled ? 'Gemini AI Ready' : 'Fallback Mode';
      chatStatusElement.style.color = ai.isGeminiEnabled ? '#4ade80' : '#fbbf24';
    }
    
    console.log('ðŸ”„ AI Status Updated:', ai.isGeminiEnabled ? 'Gemini Enabled' : 'Fallback Mode');
  }

  // Debug Panel
  $("debugPanel").addEventListener("click", () => {
    showModal('Debug Panel', `
      <div style="font-family: monospace; font-size: 12px;">
        <h4>AI Status</h4>
        <p><strong>Gemini Enabled:</strong> ${ai.isGeminiEnabled}</p>
        <p><strong>API Key Set:</strong> ${!!ai.apiKey}</p>
        <p><strong>API Key Length:</strong> ${ai.apiKey ? ai.apiKey.length : 0}</p>
        <p><strong>Base URL:</strong> ${ai.baseURL}</p>
        <p><strong>Current Model:</strong> ${ai.baseURL.includes('gemini-2.5-flash') ? 'gemini-2.5-flash' : ai.baseURL.includes('gemini-2.5-pro') ? 'gemini-2.5-pro' : ai.baseURL.includes('gemini-1.5-pro') ? 'gemini-1.5-pro' : ai.baseURL.includes('gemini-1.5-flash') ? 'gemini-1.5-flash' : 'Unknown'}</p>
        
        <h4>Quick Debug Test</h4>
        <button id="quickDebugBtn" style="padding: 8px 16px; background: var(--warning); color: white; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 10px;">
          Debug Current State
        </button>
        <button id="populateDataBtn" style="padding: 8px 16px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 10px; margin-left: 10px;">
          Add Sample Data (15 days)
        </button>
        
        <h4>Try Different Models</h4>
        <button id="testGemini25Flash" style="padding: 6px 12px; background: var(--info); color: white; border: none; border-radius: 4px; cursor: pointer; margin: 2px; font-size: 11px;">
          Test gemini-2.5-flash
        </button>
        <button id="testGemini25Pro" style="padding: 6px 12px; background: var(--info); color: white; border: none; border-radius: 4px; cursor: pointer; margin: 2px; font-size: 11px;">
          Test gemini-2.5-pro
        </button>
        <button id="testGemini15Pro" style="padding: 6px 12px; background: var(--info); color: white; border: none; border-radius: 4px; cursor: pointer; margin: 2px; font-size: 11px;">
          Test gemini-1.5-pro
        </button>
        <button id="testGemini15Flash" style="padding: 6px 12px; background: var(--info); color: white; border: none; border-radius: 4px; cursor: pointer; margin: 2px; font-size: 11px;">
          Test gemini-1.5-flash
        </button>
        
        <h4>Test Simple API Call</h4>
        <button id="simpleTestBtn" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 10px;">
          Test "Hello" Message
        </button>
        <button id="listModelsBtn" style="padding: 8px 16px; background: var(--secondary); color: white; border: none; border-radius: 6px; cursor: pointer;">
          List Available Models
        </button>
        <div id="testResult" style="margin-top: 10px; padding: 10px; background: var(--bg-light); border-radius: 6px; min-height: 50px;">
          Click test button to see result...
        </div>
        
        <h4>Browser Info</h4>
        <p><strong>User Agent:</strong> ${navigator.userAgent}</p>
        <p><strong>Protocol:</strong> ${window.location.protocol}</p>
        <p><strong>Host:</strong> ${window.location.host}</p>
      </div>
    `, [
      { text: '<i class="bi bi-x"></i> Close', primary: true }
    ]);

    // Add test functionality
    setTimeout(() => {
      const testBtn = $('simpleTestBtn');
      const listModelsBtn = $('listModelsBtn');
      const quickDebugBtn = $('quickDebugBtn');
      const populateDataBtn = $('populateDataBtn');
      const resultDiv = $('testResult');
      
      if (populateDataBtn && resultDiv) {
        populateDataBtn.onclick = async () => {
          populateDataBtn.textContent = 'Adding Data...';
          populateDataBtn.disabled = true;
          
          try {
            // Add sample data
            const sampleData = populateSampleData();
            
            // Merge with existing data (don't overwrite existing entries)
            Object.keys(sampleData).forEach(dateKey => {
              if (!store[dateKey]) {
                store[dateKey] = sampleData[dateKey];
              }
            });
            
            localStorage.setItem(STORE_KEY, JSON.stringify(store));
            
            resultDiv.innerHTML = `
              <strong>âœ… Sample Data Added!</strong><br>
              <strong>Added ${Object.keys(sampleData).length} days of sample data</strong><br>
              <strong>Total entries:</strong> ${Object.keys(store).length}<br>
              <br>
              <em>Refresh the page to see the data in your dashboard and charts.</em>
            `;
            
            // Refresh the UI
            setTimeout(() => {
              location.reload();
            }, 2000);
            
          } catch (error) {
            resultDiv.innerHTML = `
              <strong>âŒ Error adding sample data:</strong> ${error.message}
            `;
          }
          
          populateDataBtn.textContent = 'Add Sample Data (15 days)';
          populateDataBtn.disabled = false;
        };
      }
      
      if (quickDebugBtn && resultDiv) {
        quickDebugBtn.onclick = async () => {
          quickDebugBtn.textContent = 'Debugging...';
          quickDebugBtn.disabled = true;
          
          resultDiv.innerHTML = `
            <strong>ðŸ” Current AI State:</strong><br>
            <strong>isGeminiEnabled:</strong> ${ai.isGeminiEnabled}<br>
            <strong>API Key exists:</strong> ${!!ai.apiKey}<br>
            <strong>API Key length:</strong> ${ai.apiKey ? ai.apiKey.length : 0}<br>
            <strong>Base URL:</strong> ${ai.baseURL}<br>
            <strong>localStorage key:</strong> ${localStorage.getItem('gemini_api_key') ? 'Found' : 'Not found'}<br>
            <br>
            <strong>ðŸ§ª Testing simple chat response...</strong><br>
          `;
          
          try {
            const testMessage = "Hello, this is a test";
            const response = await ai.chatResponse(testMessage, []);
            resultDiv.innerHTML += `
              <strong>âœ… Chat Response:</strong><br>
              <pre style="white-space: pre-wrap; font-size: 11px; background: var(--bg-light); padding: 8px; border-radius: 4px;">${response}</pre>
            `;
          } catch (error) {
            resultDiv.innerHTML += `
              <strong>âŒ Chat Error:</strong> ${error.message}<br>
            `;
          }
          
          quickDebugBtn.textContent = 'Debug Current State';
          quickDebugBtn.disabled = false;
        };
      }
      
      if (testBtn && resultDiv) {
        testBtn.onclick = async () => {
          testBtn.textContent = 'Testing...';
          testBtn.disabled = true;
          resultDiv.innerHTML = 'Making API call...';
          
          try {
            // Direct fetch test
            const testResponse = await fetch(ai.baseURL, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-goog-api-key': ai.apiKey
              },
              body: JSON.stringify({
                contents: [{
                  parts: [{
                    text: "Say hello"
                  }]
                }],
                generationConfig: {
                  temperature: 0.7,
                  maxOutputTokens: 500
                }
              })
            });
            
            const responseText = await testResponse.text();
            
            resultDiv.innerHTML = `
              <strong>Status:</strong> ${testResponse.status}<br>
              <strong>Response:</strong><br>
              <pre style="white-space: pre-wrap; font-size: 10px;">${responseText}</pre>
            `;
            
          } catch (error) {
            resultDiv.innerHTML = `
              <strong>Error:</strong> ${error.message}<br>
              <strong>Stack:</strong><br>
              <pre style="white-space: pre-wrap; font-size: 10px;">${error.stack}</pre>
            `;
          }
          
          testBtn.textContent = 'Test "Hello" Message';
          testBtn.disabled = false;
        };
      }

      if (listModelsBtn && resultDiv) {
        listModelsBtn.onclick = async () => {
          listModelsBtn.textContent = 'Loading...';
          listModelsBtn.disabled = true;
          resultDiv.innerHTML = 'Fetching available models...';
          
          try {
            // List available models using v1beta API
            const modelsResponse = await fetch('https://generativelanguage.googleapis.com/v1beta/models', {
              headers: {
                'x-goog-api-key': ai.apiKey
              }
            });
            const modelsText = await modelsResponse.text();
            
            resultDiv.innerHTML = `
              <strong>Available Models (v1beta API):</strong><br>
              <pre style="white-space: pre-wrap; font-size: 10px;">${modelsText}</pre>
            `;
            
          } catch (error) {
            resultDiv.innerHTML = `
              <strong>Error:</strong> ${error.message}
            `;
          }
          
          listModelsBtn.textContent = 'List Available Models';
          listModelsBtn.disabled = false;
        };
      }

      // Add model testing functionality
      const modelTests = [
        { id: 'testGemini25Flash', model: 'gemini-2.5-flash' },
        { id: 'testGemini25Pro', model: 'gemini-2.5-pro' },
        { id: 'testGemini15Pro', model: 'gemini-1.5-pro' },
        { id: 'testGemini15Flash', model: 'gemini-1.5-flash' }
      ];

      modelTests.forEach(({ id, model }) => {
        const btn = $(id);
        if (btn) {
          btn.onclick = async () => {
            const originalText = btn.textContent;
            btn.textContent = 'Testing...';
            btn.disabled = true;
            resultDiv.innerHTML = `Testing ${model}...`;
            
            try {
              const testURL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;
              const response = await fetch(testURL, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-goog-api-key': ai.apiKey
                },
                body: JSON.stringify({
                  contents: [{
                    parts: [{
                      text: "Say hello in one sentence"
                    }]
                  }],
                  generationConfig: {
                    temperature: 0.7,
                    maxOutputTokens: 500
                  }
                })
              });
              
              const responseText = await response.text();
              
              if (response.ok) {
                const data = JSON.parse(responseText);
                const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response text found';
                resultDiv.innerHTML = `
                  <strong>âœ… ${model} SUCCESS</strong><br>
                  <strong>Response:</strong> ${reply}<br>
                  <button onclick="ai.baseURL='${testURL}'; updateAIStatus(); showAlert('Model updated to ${model}', 'Model Changed');" style="margin-top: 8px; padding: 4px 8px; background: var(--success); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                    Use This Model
                  </button>
                `;
              } else {
                resultDiv.innerHTML = `
                  <strong>âŒ ${model} FAILED</strong><br>
                  <strong>Status:</strong> ${response.status}<br>
                  <strong>Error:</strong><br>
                  <pre style="white-space: pre-wrap; font-size: 10px;">${responseText}</pre>
                `;
              }
              
            } catch (error) {
              resultDiv.innerHTML = `
                <strong>âŒ ${model} ERROR</strong><br>
                <strong>Error:</strong> ${error.message}
              `;
            }
            
            btn.textContent = originalText;
            btn.disabled = false;
          };
        }
      });
    }, 100);
  });

  // Configure AI button
  $("configureAI").addEventListener("click", () => {
    const currentKey = ai.apiKey || '';
    const message = ai.isGeminiEnabled ? 
      'Gemini AI is currently enabled. Enter a new API key or leave blank to disable:' :
      'Configure Gemini AI for enhanced responses. Get your free API key from Google AI Studio:';
    
    showModal('Configure Gemini AI', `
      <div style="margin-bottom: 16px;">
        <p>${message}</p>
        ${!ai.isGeminiEnabled ? '<p><a href="https://makersuite.google.com/app/apikey" target="_blank" style="color: var(--primary);">Get API Key from Google AI Studio â†’</a></p>' : ''}
      </div>
      <input type="password" id="apiKeyInput" class="modal-input" placeholder="Enter Gemini API Key" value="${currentKey}">
      <div style="margin-top: 12px; font-size: 12px; color: var(--text-secondary);">
        <i class="bi bi-shield-check"></i> Your API key is stored locally and never shared.
      </div>
      <div style="margin-top: 8px; padding: 12px; background: var(--bg-light); border-radius: 8px; font-size: 13px;">
        <strong>Status:</strong> ${ai.isGeminiEnabled ? 
          '<span style="color: var(--success);">âœ… Gemini AI Enabled</span>' : 
          '<span style="color: var(--warning);">âš ï¸ Using Fallback Responses</span>'}
        ${ai.isGeminiEnabled ? '<br><button id="testApiBtn" style="margin-top: 8px; padding: 4px 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Test API Connection</button>' : ''}
      </div>
    `, [
      { text: '<i class="bi bi-x"></i> Cancel', primary: false },
      { 
        text: '<i class="bi bi-check"></i> Save', 
        primary: true, 
        onClick: () => {
          const newKey = $('apiKeyInput').value.trim();
          if (newKey) {
            ai.setApiKey(newKey);
            updateAIStatus();
            showAlert('Gemini AI configured successfully! Try sending a message to test it.', 'AI Configured');
          } else {
            ai.setApiKey('');
            updateAIStatus();
            showAlert('Gemini AI disabled. Using fallback responses.', 'AI Disabled');
          }
        }
      }
    ]);

    // Add test button functionality after modal is shown
    setTimeout(() => {
      const testBtn = $('testApiBtn');
      if (testBtn) {
        testBtn.onclick = async () => {
          testBtn.textContent = 'Testing...';
          testBtn.disabled = true;
          
          try {
            const testResponse = await ai.callGeminiAPI('Hello, this is a test message.');
            showAlert(`âœ… API Test Successful!\n\nResponse: "${testResponse}"`, 'API Test Result');
          } catch (error) {
            showAlert(`âŒ API Test Failed!\n\nError: ${error.message}\n\nPlease check your API key and try again.`, 'API Test Result');
          }
          
          testBtn.textContent = 'Test API Connection';
          testBtn.disabled = false;
        };
      }
    }, 100);
  });

  function toast(msg) {
    showAlert(msg);
  }

  const STORE_KEY = "WELLNESS_DATA_V3";
  const CONTACT_KEY = "CONTACTS_V3";
  const THEME_KEY = "THEME_V3";

  let store = JSON.parse(localStorage.getItem(STORE_KEY) || "{}");
  let contacts = JSON.parse(localStorage.getItem(CONTACT_KEY) || "[]");

  // Function to populate sample data for last 15 days
  function populateSampleData() {
    const today = new Date();
    const sampleData = {};
    
    for (let i = 14; i >= 0; i--) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      const dateKey = date.toISOString().slice(0, 10);
      
      // Create realistic sample data with some variation
      const baseValues = {
        mood: Math.floor(Math.random() * 5), // 0-4
        anxiety: Math.floor(Math.random() * 10) + 1, // 1-10
        stress: Math.floor(Math.random() * 10) + 1, // 1-10
        focus: Math.floor(Math.random() * 10) + 1, // 1-10
        prod: Math.floor(Math.random() * 10) + 1, // 1-10 (productivity)
        energy: Math.floor(Math.random() * 10) + 1, // 1-10
        sleep: Math.floor(Math.random() * 10) + 1, // 1-10
      };
      
      // Add some realistic patterns (weekends might be different, etc.)
      const dayOfWeek = date.getDay();
      if (dayOfWeek === 0 || dayOfWeek === 6) { // Weekend
        baseValues.stress = Math.max(1, baseValues.stress - 2); // Lower stress on weekends
        baseValues.mood = Math.min(4, baseValues.mood + 1); // Better mood on weekends
        baseValues.sleep = Math.min(10, baseValues.sleep + 1); // Better sleep on weekends
      }
      
      // Create sample notes based on the day
      const sampleNotes = [
        "Had a productive day at work. Feeling good about progress on my projects.",
        "Felt a bit overwhelmed with deadlines today. Need to practice better time management.",
        "Great day! Went for a walk during lunch break which really helped my mood.",
        "Struggled with focus today. Too many distractions. Need to create a better workspace.",
        "Excellent sleep last night. Woke up feeling refreshed and energized.",
        "Feeling anxious about upcoming presentation. Practiced deep breathing exercises.",
        "Wonderful weekend! Spent time with family and friends. Feeling grateful.",
        "Challenging day but managed to stay positive. Meditation really helped.",
        "Low energy today. Maybe need to adjust my diet and exercise routine.",
        "Accomplished my goals for the day. Feeling satisfied and motivated.",
        "Had some stress at work but handled it well. Proud of my progress.",
        "Beautiful weather today! Spent time outdoors which boosted my mood significantly.",
        "Feeling more balanced lately. The daily tracking is really helping me understand patterns.",
        "Tough day emotionally but reached out to friends for support. Feeling better now.",
        "Productive morning routine set a positive tone for the entire day."
      ];
      
      sampleData[dateKey] = {
        date: dateKey,
        mood: baseValues.mood,
        anxiety: baseValues.anxiety,
        stress: baseValues.stress,
        focus: baseValues.focus,
        prod: baseValues.prod,
        energy: baseValues.energy,
        sleep: baseValues.sleep,
        notes: sampleNotes[i % sampleNotes.length],
        timestamp: date.toISOString()
      };
    }
    
    return sampleData;
  }

  // Check if store is empty and populate with sample data
  if (Object.keys(store).length === 0) {
    console.log('ðŸ“Š Populating sample data for last 15 days...');
    store = populateSampleData();
    localStorage.setItem(STORE_KEY, JSON.stringify(store));
    console.log('âœ… Sample data populated!');
  }

  // Fix any existing data that might have wrong property names
  function fixExistingData() {
    let dataFixed = false;
    Object.keys(store).forEach(dateKey => {
      const entry = store[dateKey];
      
      // Fix productivity -> prod
      if (entry.productivity !== undefined && entry.prod === undefined) {
        entry.prod = entry.productivity;
        delete entry.productivity;
        dataFixed = true;
      }
      
      // Ensure all numeric values are actually numbers
      ['mood', 'anxiety', 'stress', 'focus', 'prod', 'energy', 'sleep'].forEach(prop => {
        if (entry[prop] !== undefined) {
          entry[prop] = Number(entry[prop]) || 0;
        }
      });
    });
    
    if (dataFixed) {
      localStorage.setItem(STORE_KEY, JSON.stringify(store));
      console.log('ðŸ”§ Fixed existing data property names');
    }
  }

  // Fix existing data on load
  fixExistingData();

  const themeToggle = $("themeToggle");
  const themeIcon = $("themeIcon");

  function applyTheme(mode) {
    if (mode === "dark") {
      document.documentElement.setAttribute("data-theme", "dark");
      themeIcon.className = "bi bi-sun";
    } else {
      document.documentElement.removeAttribute("data-theme");
      themeIcon.className = "bi bi-moon";
    }
    localStorage.setItem(THEME_KEY, mode);
  }

  applyTheme(localStorage.getItem(THEME_KEY) || "light");

  themeToggle.addEventListener("click", () => {
    const current = document.documentElement.getAttribute("data-theme");
    applyTheme(current === "dark" ? "light" : "dark");
  });

  $("todayLabel").textContent = new Date().toLocaleDateString(undefined, {
    weekday: "short",
    month: "short",
    day: "numeric"
  });

  setInterval(() => {
    $("localTime").textContent = new Date().toLocaleTimeString();
  }, 1000);

  const moods = [
    { id: 0, emoji: "ðŸ˜­", label: "Very low" },
    { id: 1, emoji: "ðŸ˜•", label: "Low" },
    { id: 2, emoji: "ðŸ˜", label: "Okay" },
    { id: 3, emoji: "ðŸ™‚", label: "Good" },
    { id: 4, emoji: "ðŸ˜„", label: "Great" }
  ];

  const moodRow = $("moodRow");
  moodRow.innerHTML = "";
  moods.forEach(m => {
    const btn = document.createElement("button");
    btn.className = "mood-btn";
    btn.dataset.mood = m.id;
    btn.innerHTML = `<div class="mood-emoji">${m.emoji}</div><div style="font-size: 14px; font-weight: 600;">${m.label}</div>`;
    btn.addEventListener("click", () => {
      moodRow.querySelectorAll(".mood-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      updateWellnessPreview();
    });
    moodRow.appendChild(btn);
  });

  function getSelectedMood() {
    const active = moodRow.querySelector(".mood-btn.active");
    return active ? Number(active.dataset.mood) : null;
  }

  function bindRange(id, label) {
    const input = $(id);
    const span = $(label);
    span.textContent = input.value;
    input.addEventListener("input", () => {
      span.textContent = input.value;
      updateWellnessPreview();
    });
  }

  bindRange("anxiety", "anxietyVal");
  bindRange("stress", "stressVal");
  bindRange("focus", "focusVal");
  bindRange("prodRange", "prodVal");
  bindRange("energy", "energyVal");
  bindRange("sleep", "sleepVal");

  function updateWellnessPreview() {
    const mood = getSelectedMood();
    if (mood === null) return;

    const entry = {
      mood,
      anxiety: Number($("anxiety").value),
      stress: Number($("stress").value),
      focus: Number($("focus").value),
      prod: Number($("prodRange").value),
      energy: Number($("energy").value),
      sleep: Number($("sleep").value)
    };

    const score = ai.computeScore(entry);
    $("wellnessScore").textContent = score;
    
    const text = $("wellnessText");
    if (score >= 80) text.textContent = "Excellent! You're doing great! ðŸŽ‰";
    else if (score >= 60) text.textContent = "Good! Keep it up! ðŸ‘";
    else text.textContent = "Needs attention. Take care of yourself. â¤ï¸";
  }

  function updateWellnessUI(entry) {
    if (!entry) {
      $("wellnessScore").textContent = "--";
      $("wellnessText").textContent = "Track your mood to see your score";
      return;
    }

    const score = ai.computeScore(entry);
    $("wellnessScore").textContent = score;
    
    const text = $("wellnessText");
    if (score >= 80) text.textContent = "Excellent! You're doing great! ðŸŽ‰";
    else if (score >= 60) text.textContent = "Good! Keep it up! ðŸ‘";
    else text.textContent = "Needs attention. Take care of yourself. â¤ï¸";
  }

  function showAIInsights(entry) {
    const insights = ai.analyzeEntry(entry);
    const card = $("aiInsightsCard");
    const content = $("aiInsightsContent");
    
    if (insights.length > 0) {
      content.innerHTML = insights.map(i => `<div style="margin: 8px 0; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 8px;">${i}</div>`).join("");
      card.style.display = "block";
    }
  }

  function saveToday() {
    const mood = getSelectedMood();
    if (mood == null) return toast("Select mood first!");

    const entry = {
      date: new Date().toISOString().slice(0, 10),
      mood,
      anxiety: Number($("anxiety").value),
      stress: Number($("stress").value),
      focus: Number($("focus").value),
      prod: Number($("prodRange").value),
      energy: Number($("energy").value),
      sleep: Number($("sleep").value),
      title: $("noteTitle").value.trim(),
      note: $("noteBody").value.trim()
    };

    store[entry.date] = entry;
    localStorage.setItem(STORE_KEY, JSON.stringify(store));
    updateWellnessUI(entry);
    showAIInsights(entry);
    renderEntries();
    updateStats();
    updateChart();
    toast("âœ… Entry saved successfully!");
  }

  $("saveBtn").onclick = saveToday;

  $("analyzeBtn").onclick = () => {
    const key = new Date().toISOString().slice(0, 10);
    const entry = store[key];
    
    if (!entry) {
      toast("Save an entry first to get AI analysis!");
      return;
    }

    const sentiment = ai.analyzeSentiment(entry.note);
    const insights = ai.analyzeEntry(entry);
    const history = Object.values(store).sort((a, b) => a.date.localeCompare(b.date));
    const recommendations = ai.generateRecommendations(history);

    let analysis = `<h4>ðŸ¤– AI Analysis</h4>`;
    analysis += `<p><strong>Sentiment:</strong> ${sentiment.toUpperCase()}</p>`;
    analysis += `<h5>Insights:</h5><ul>`;
    insights.forEach(i => analysis += `<li>${i}</li>`);
    analysis += `</ul><h5>Recommendations:</h5><ul>`;
    recommendations.forEach(r => analysis += `<li>${r}</li>`);
    analysis += `</ul>`;

    const card = $("aiInsightsCard");
    const content = $("aiInsightsContent");
    content.innerHTML = analysis;
    card.style.display = "block";
    card.scrollIntoView({ behavior: "smooth" });
  };

  function clearToday() {
    const key = new Date().toISOString().slice(0, 10);
    delete store[key];
    localStorage.setItem(STORE_KEY, JSON.stringify(store));
    loadToday();
    toast("Cleared");
  }

  $("clearBtn").onclick = clearToday;

  function exportToday() {
    const key = new Date().toISOString().slice(0, 10);
    const e = store[key];

    if (!e) return toast("No entry to export");

    const txt = `Cool-Mind AI Tracker Export
Date: ${e.date}
Mood: ${moods[e.mood].label}
Wellness Score: ${ai.computeScore(e)}

Metrics:
- Stress: ${e.stress}/10
- Anxiety: ${e.anxiety}/10
- Focus: ${e.focus}/10
- Productivity: ${e.prod}/10
- Energy: ${e.energy}/10
- Sleep: ${e.sleep} hours

Title: ${e.title}

Journal Entry:
${e.note}

AI Insights:
${ai.analyzeEntry(e).join("\n")}`;

    const blob = new Blob([txt], { type: "text/plain" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "wellness-" + e.date + ".txt";
    a.click();
  }

  $("exportBtn").onclick = exportToday;

  function loadToday() {
    const key = new Date().toISOString().slice(0, 10);
    const e = store[key];

    if (!e) {
      $("noteTitle").value = "";
      $("noteBody").value = "";
      updateWellnessUI(null);
      return;
    }

    $("noteTitle").value = e.title;
    $("noteBody").value = e.note;

    document.querySelectorAll(".mood-btn").forEach(b => 
      b.classList.toggle("active", Number(b.dataset.mood) === e.mood)
    );

    $("anxiety").value = e.anxiety;
    $("stress").value = e.stress;
    $("focus").value = e.focus;
    $("prodRange").value = e.prod;
    $("energy").value = e.energy;
    $("sleep").value = e.sleep;

    $("anxietyVal").textContent = e.anxiety;
    $("stressVal").textContent = e.stress;
    $("focusVal").textContent = e.focus;
    $("prodVal").textContent = e.prod;
    $("energyVal").textContent = e.energy;
    $("sleepVal").textContent = e.sleep;

    updateWellnessUI(e);
    showAIInsights(e);
  }

  loadToday();

  function updateStats() {
    const entries = Object.values(store);
    $("totalEntries").textContent = entries.length;

    if (entries.length > 0) {
      const avgScore = entries.reduce((sum, e) => sum + ai.computeScore(e), 0) / entries.length;
      $("avgScore").textContent = Math.round(avgScore);

      const moodCounts = [0, 0, 0, 0, 0];
      entries.forEach(e => moodCounts[e.mood]++);
      const maxMood = moodCounts.indexOf(Math.max(...moodCounts));
      $("bestMood").textContent = moods[maxMood].emoji;

      const dates = Object.keys(store).sort().reverse();
      let streak = 0;
      
      for (let i = 0; i < dates.length; i++) {
        const expectedDate = new Date();
        expectedDate.setDate(expectedDate.getDate() - i);
        const expected = expectedDate.toISOString().slice(0, 10);
        
        if (dates[i] === expected) {
          streak++;
        } else {
          break;
        }
      }
      
      $("streak").textContent = streak;
    }
  }

  updateStats();

  let chart = null;

  function updateChart() {
    const entries = Object.values(store).sort((a, b) => a.date.localeCompare(b.date)).slice(-14);
    
    const ctx = $("trendChart").getContext("2d");
    
    if (chart) chart.destroy();

    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: entries.map(e => new Date(e.date).toLocaleDateString("en", { month: "short", day: "numeric" })),
        datasets: [
          {
            label: "Wellness Score",
            data: entries.map(e => ai.computeScore(e)),
            borderColor: "#6366f1",
            backgroundColor: "rgba(99, 102, 241, 0.1)",
            tension: 0.4,
            fill: true
          },
          {
            label: "Mood",
            data: entries.map(e => e.mood * 25),
            borderColor: "#8b5cf6",
            backgroundColor: "rgba(139, 92, 246, 0.1)",
            tension: 0.4,
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: "top"
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100
          }
        }
      }
    });
  }

  updateChart();

  function renderEntries() {
    const wrap = $("entriesList");
    wrap.innerHTML = "";

    const keys = Object.keys(store).sort().reverse().slice(0, 10);
    if (keys.length === 0) {
      wrap.innerHTML = "<div style='text-align: center; padding: 32px; color: var(--text-secondary);'>No entries yet. Start tracking your mental wellness!</div>";
      return;
    }

    keys.forEach(k => {
      const e = store[k];
      const score = ai.computeScore(e);

      const div = document.createElement("div");
      div.style.cssText = "padding: 20px; border: 1px solid var(--border); border-radius: 16px; margin-bottom: 16px; background: var(--bg-card);";

      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
          <div>
            <div style="font-size: 24px; margin-bottom: 4px;">${moods[e.mood].emoji}</div>
            <strong style="font-size: 16px;">${e.title || moods[e.mood].label}</strong>
            <div style="color: var(--text-secondary); font-size: 14px; margin-top: 4px;">${new Date(k).toLocaleDateString("en", { weekday: "long", month: "long", day: "numeric" })}</div>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${score}</div>
            <div style="font-size: 12px; color: var(--text-secondary);">Wellness Score</div>
            <button class="btn-outline-modern btn-modern delete-entry" style="margin-top: 8px; padding: 6px 12px; font-size: 12px;">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
        ${e.note ? `<div style="color: var(--text-secondary); font-size: 14px; line-height: 1.6; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">${e.note.substring(0, 150)}${e.note.length > 150 ? "..." : ""}</div>` : ""}
      `;

      div.querySelector(".delete-entry").onclick = () => {
        showConfirm("Are you sure you want to delete this entry?", () => {
          delete store[k];
          localStorage.setItem(STORE_KEY, JSON.stringify(store));
          renderEntries();
          updateStats();
          updateChart();
          showAlert("Entry deleted successfully!");
        }, "Delete Entry");
      };

      wrap.appendChild(div);
    });
  }

  renderEntries();

  function renderContacts() {
    const wrap = $("contactsWrap");
    wrap.innerHTML = "";

    if (contacts.length === 0) {
      wrap.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--text-secondary); font-size: 14px;">No personal contacts added yet</div>';
      return;
    }

    contacts.forEach(c => {
      const chip = document.createElement("div");
      chip.style.cssText = "display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: var(--bg-light); border: 1px solid var(--border); border-radius: 16px; width: 100%; margin-bottom: 8px;";

      chip.innerHTML = `
        <i class="bi bi-person-circle" style="font-size: 24px; color: var(--primary);"></i>
        <div style="flex: 1;">
          <strong>${c.name}</strong>
          <div style="color: var(--text-secondary); font-size: 14px;">${c.number}</div>
        </div>
        <a href="tel:${c.number}" class="btn-primary-modern btn-modern" style="padding: 8px 16px; font-size: 14px; text-decoration: none;">
          <i class="bi bi-telephone-fill"></i> Call
        </a>
        <button class="btn-outline-modern btn-modern remove-contact" style="padding: 8px 12px; font-size: 14px;">
          <i class="bi bi-trash"></i>
        </button>
      `;

      chip.querySelector(".remove-contact").onclick = () => {
        showConfirm(`Remove ${c.name} from emergency contacts?`, () => {
          contacts = contacts.filter(x => x.id !== c.id);
          localStorage.setItem(CONTACT_KEY, JSON.stringify(contacts));
          renderContacts();
          showAlert("Contact removed successfully!");
        }, "Remove Contact");
      };

      wrap.appendChild(chip);
    });
  }

  renderContacts();

  $("addContactBtn").onclick = () => {
    const name = $("contactName").value.trim();
    const num = $("contactNumber").value.trim();

    if (!name || !/^\d{6,15}$/.test(num)) return toast("Invalid contact");

    contacts.push({ id: "c" + Date.now(), name, number: num });
    localStorage.setItem(CONTACT_KEY, JSON.stringify(contacts));
    $("contactName").value = "";
    $("contactNumber").value = "";
    renderContacts();
  };

  $("openMapsBtn").onclick = () =>
    window.open("https://www.google.com/maps/search/mental+health+clinic", "_blank");

  const chatToggle = $("chatToggle");
  const chatWindow = $("chatWindow");
  const chatMessages = $("chatMessages");
  const chatInput = $("chatInput");
  const chatSend = $("chatSend");
  const chatClose = $("chatClose");
  const chatBackdrop = $("chatBackdrop");

  function openChat() {
    chatWindow.classList.add("active");
    chatBackdrop.classList.add("active");
    document.body.style.overflow = window.innerWidth <= 768 ? "hidden" : "auto";
  }

  function closeChat() {
    chatWindow.classList.remove("active");
    chatBackdrop.classList.remove("active");
    document.body.style.overflow = "auto";
  }

  chatToggle.onclick = () => {
    if (chatWindow.classList.contains("active")) {
      closeChat();
    } else {
      openChat();
    }
  };

  chatClose.onclick = closeChat;
  chatBackdrop.onclick = closeChat;

  function addMessage(text, isUser = false) {
    const msg = document.createElement("div");
    msg.className = `chat-message ${isUser ? "user" : "ai"}`;
    
    // Format markdown-style text for AI messages
    if (!isUser) {
      // Convert **bold** to <strong>
      text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      // Convert line breaks
      text = text.replace(/\n/g, '<br>');
      msg.innerHTML = text;
    } else {
      msg.textContent = text;
    }
    
    chatMessages.appendChild(msg);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function sendChatMessage() {
    const text = chatInput.value.trim();
    if (!text) return;

    console.log('ðŸ“¨ sendChatMessage called with:', text);
    console.log('ðŸ¤– AI state - isGeminiEnabled:', ai.isGeminiEnabled);
    console.log('ðŸ”‘ AI state - hasApiKey:', !!ai.apiKey);

    addMessage(text, true);
    chatInput.value = "";

    // Show typing indicator
    const typingMsg = document.createElement("div");
    typingMsg.className = "chat-message ai";
    typingMsg.innerHTML = '<i class="bi bi-three-dots" style="animation: pulse 1s infinite;"></i> Thinking...';
    chatMessages.appendChild(typingMsg);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // Direct Gemini API integration
    async function getGeminiResponse(message) {
      // Check if Gemini is enabled and API key exists
      if (!ai.isGeminiEnabled || !ai.apiKey) {
        console.log('âš ï¸ Gemini not enabled, using fallback');
        return getFallbackResponse(message);
      }

      try {
        console.log('ðŸš€ Making direct Gemini API call...');
        
        const prompt = `You are a supportive mental health assistant. Respond to this message with empathy and helpful advice in 1-2 sentences: "${message}"`;
        
        const requestBody = {
          contents: [{
            parts: [{
              text: prompt
            }]
          }],
          generationConfig: {
            temperature: 0.7,
            maxOutputTokens: 500
          },
          systemInstruction: {
            parts: [{
              text: "You are a supportive mental health assistant. Provide direct, helpful responses without internal reasoning or thinking steps."
            }]
          }
        };

        console.log('ðŸ“¤ Sending request to:', ai.baseURL);
        console.log('ðŸ“¤ Request body:', JSON.stringify(requestBody, null, 2));

        const response = await fetch(ai.baseURL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-goog-api-key': ai.apiKey
          },
          body: JSON.stringify(requestBody)
        });

        console.log('ðŸ“¥ Response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('âŒ Gemini API Error:', errorText);
          throw new Error(`Gemini API Error ${response.status}: ${errorText}`);
        }

        const data = await response.json();
        console.log('ðŸ“Š Gemini response data:', data);

        if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
          const responseText = data.candidates[0].content.parts[0].text.trim();
          console.log('âœ… Gemini response:', responseText);
          
          // Clean up markdown formatting
          const cleanResponse = responseText.replace(/\*\*(.*?)\*\*/g, '$1').replace(/\*(.*?)\*/g, '$1');
          return cleanResponse;
        } else {
          console.error('âŒ Invalid Gemini response structure');
          throw new Error('Invalid response structure from Gemini');
        }

      } catch (error) {
        console.error('ðŸ’¥ Gemini API call failed:', error);
        return getFallbackResponse(message);
      }
    }

    // Fallback response function
    function getFallbackResponse(message) {
      console.log('ðŸ”„ Using fallback response for:', message);
      const lowerMsg = message.toLowerCase();
      
      // Crisis detection
      if (lowerMsg.match(/\b(suicide|kill myself|end it all|want to die|hurt myself|self harm)\b/)) {
        return "ðŸš¨ I'm very concerned about you. Please reach out for immediate help: 988 - Suicide & Crisis Lifeline (US), Crisis Text Line: Text HOME to 741741. You matter, and there are people who want to help.";
      }

      // Greetings
      if (lowerMsg.match(/\b(hello|hi|hey|good morning|good evening|greetings)\b/)) {
        const greetings = [
          "Hello! I'm here to support your mental wellness journey. How are you feeling today?",
          "Hi there! I'm your AI mental health companion. What's on your mind?",
          "Welcome! I'm here to listen and help. How can I support you today?"
        ];
        return greetings[Math.floor(Math.random() * greetings.length)];
      }
      
      // Anxiety responses
      if (lowerMsg.match(/\b(anxious|anxiety|panic|worried|nervous|fear|scared)\b/)) {
        const responses = [
          "I understand anxiety can be overwhelming. Try the 4-7-8 breathing technique: breathe in for 4 seconds, hold for 7, exhale for 8.",
          "Anxiety is tough, but you're not alone. Try the 5-4-3-2-1 grounding technique: Name 5 things you see, 4 you can touch, 3 you hear, 2 you smell, and 1 you taste.",
          "When anxiety strikes, remember: this feeling is temporary. Try progressive muscle relaxation or a short walk."
        ];
        return responses[Math.floor(Math.random() * responses.length)];
      }
      
      // Stress responses
      if (lowerMsg.match(/\b(stress|stressed|overwhelm|overwhelmed|pressure|burnout)\b/)) {
        const responses = [
          "Stress management is key. Try the Pomodoro Technique: Work for 25 minutes, then take a 5-minute break.",
          "When overwhelmed, break tasks into tiny steps. Instead of 'finish project', try 'write first paragraph'.",
          "Remember to be kind to yourself. You're doing your best, and that's enough."
        ];
        return responses[Math.floor(Math.random() * responses.length)];
      }
      
      // Default supportive responses
      const supportResponses = [
        "Thank you for sharing that with me. What would be most helpful for you right now?",
        "I'm here to listen and support you. How are you feeling about this situation?",
        "Remember, seeking help is a sign of strength, not weakness.",
        "You're taking important steps by tracking your mental health. That's commendable!"
      ];
      return supportResponses[Math.floor(Math.random() * supportResponses.length)];
    }

    // Get response and handle it
    getGeminiResponse(text).then(response => {
      console.log('âœ… Final response:', response);
      if (chatMessages.contains(typingMsg)) {
        chatMessages.removeChild(typingMsg);
      }
      addMessage(response, false);
    }).catch(error => {
      console.error('âŒ Error in getGeminiResponse:', error);
      if (chatMessages.contains(typingMsg)) {
        chatMessages.removeChild(typingMsg);
      }
      addMessage("I'm having trouble connecting right now. Please try again in a moment.", false);
    });
  }

  chatSend.onclick = sendChatMessage;
  chatInput.onkeypress = (e) => {
    if (e.key === "Enter") sendChatMessage();
  };

});
  </script>
</body>
</html>
